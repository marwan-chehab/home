<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Device Status</title>
    <style>
        table {
            width: 60%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid black;
            padding: 10px;
            text-align: center;
        }
        .status-indicator {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-left: 10px;
        }
        .green { background-color: green; }
        .red { background-color: red; }
    </style>
</head>
<body>
    <h2>Device Control</h2>

    <table id="deviceTable">
        <tr>
            <th>Device</th>
            <th>Status</th>
            <th>Last Updated</th>
            <th>Update</th>
        </tr>
        {% for device in devices %}
        <tr id="device-{{ device.device_type }}">
            <td>{{ device.device_type.capitalize() }}</td>
            <td>
                <strong class="device-status">{{ device.status }}</strong>
                <span class="status-indicator {% if device.status == 'on' %}green{% else %}red{% endif %}"></span>
            </td>
            <td class="device-timestamp">{{ device.latest_stamp if device.latest_stamp else "N/A" }}</td>
            <td>
                <form class="update-form" data-device="{{ device.device_type }}">
                    <select name="onoff">
                        <option value="on" {% if device.status == 'off' %}selected{% endif %}>On</option>
                        <option value="off" {% if device.status == 'on' %}selected{% endif %}>Off</option>
                    </select>
                    <button type="submit">Update</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>

    <br>
    <a href="/">Go Home</a>

    <script>
        async function fetchDeviceStatus() {
            try {
                const response = await fetch('/update_status');
                const devices = await response.json();

                devices.forEach(device => {
                    let row = document.getElementById(`device-${device.device_type}`);

                    if (!row) {
                        // If row does not exist, create it
                        row = document.createElement("tr");
                        row.id = `device-${device.device_type}`;
                        row.innerHTML = `
                            <td>${device.device_type.charAt(0).toUpperCase() + device.device_type.slice(1)}</td>
                            <td>
                                <strong class="device-status">${device.status}</strong>
                                <span class="status-indicator ${device.status === 'on' ? 'green' : 'red'}"></span>
                            </td>
                            <td class="device-timestamp">${device.latest_stamp || "N/A"}</td>
                            <td>
                                <form class="update-form" data-device="${device.device_type}">
                                    <select name="onoff">
                                        <option value="on" ${device.status === 'off' ? 'selected' : ''}>On</option>
                                        <option value="off" ${device.status === 'on' ? 'selected' : ''}>Off</option>
                                    </select>
                                    <button type="submit">Update</button>
                                </form>
                            </td>
                        `;
                        document.getElementById("deviceTable").appendChild(row);
                    } else {
                        // Update existing row
                        row.querySelector(".device-status").textContent = device.status;
                        row.querySelector(".status-indicator").className = "status-indicator " + (device.status === "on" ? "green" : "red");
                        row.querySelector(".device-timestamp").textContent = device.latest_stamp || "N/A";
                        row.querySelector("select[name='onoff']").value = device.status;
                    }
                });
            } catch (error) {
                console.error("Error updating device table:", error);
            }
        }

        // Attach event listener using event delegation (ensures it works dynamically)
        document.addEventListener("submit", async function(event) {
            if (event.target.classList.contains("update-form")) {
                event.preventDefault();

                const form = event.target;
                const deviceType = form.dataset.device;
                const newStatus = form.querySelector("select[name='onoff']").value;

                try {
                    const response = await fetch("/submit_status", {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: new URLSearchParams({ device_type: deviceType, onoff: newStatus })
                    });

                    if (response.ok) {
                        fetchDeviceStatus(); // Refresh table immediately after update
                    }
                } catch (error) {
                    console.error("Error updating status:", error);
                }
            }
        });

        setInterval(fetchDeviceStatus, 5000); // Auto-refresh every 5 seconds
    </script>

</body>
</html>
