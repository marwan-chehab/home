#include <Wire.h>
#include <ArduinoJson.h>
#include "BluetoothSerial.h"
#include <WiFi.h>
#include <HTTPClient.h>
#include <Preferences.h>

// Define I2C Slave Address for Arduino
#define SLAVE_ADDR 8  

String ssid;
String pw;
String serverUrl;

BluetoothSerial SerialBT;
Preferences preferences;

void setup() {
    Serial.begin(115200);
    
    Serial.println("Initializing Preferences...");
    preferences.begin("my-app", false);

    // Load stored WiFi credentials
    ssid = preferences.getString("ssid", "Marwan-2.4G-");
    pw = preferences.getString("password", "z31n4bm4ri4m_$20142018$");
    serverUrl = preferences.getString("serverUrl", "http://35.181.4.56:5000/get_device_statuses");

    Serial.println("Connecting to WiFi...");
    WiFi.begin(ssid.c_str(), pw.c_str());

    int retry = 0;
    while (WiFi.status() != WL_CONNECTED && retry < 20) {
        delay(1000);
        Serial.print(".");
        retry++;
    }

    if (WiFi.status() == WL_CONNECTED) {
        Serial.println("\nConnected to WiFi");
        Serial.print("IP Address: ");
        Serial.println(WiFi.localIP());
    } else {
        Serial.println("\nFailed to connect to WiFi.");
    }

    SerialBT.begin("ESPBT");  
    Serial.println("Bluetooth started. Pair and send commands.");
    
    Wire.begin();  
}

void loop() {
    if (SerialBT.available()) {
        String input = SerialBT.readStringUntil('\n');
        handleBluetoothInput(input);
    }

    if (WiFi.status() == WL_CONNECTED) {
        fetchAndSendDeviceStatuses();
    } else {
        SerialBT.println("WiFi Disconnected");
        Serial.println("WiFi Disconnected");
    }
    
    delay(2000);  // Fetch every 2 seconds
}

// ‚úÖ Fetch all devices dynamically
void fetchAndSendDeviceStatuses() {
    Serial.println("üì° Fetching Device Statuses...");
    
    HTTPClient http;
    http.begin(serverUrl);
    
    int httpResponseCode = http.GET();
    if (httpResponseCode > 0) {
        String payload = http.getString();
        Serial.println("Received JSON: " + payload);

        // Parse JSON response
        DynamicJsonDocument doc(1024);
        DeserializationError error = deserializeJson(doc, payload);
        if (error) {
            Serial.println("‚ùå JSON Parsing Failed!");
            return;
        }

        // Iterate through each device in the JSON array
        for (JsonObject device : doc.as<JsonArray>()) {
            String deviceType = device["device_type"];
            String status = device["status"];

            Serial.println("üì° Sending to Arduino: " + deviceType + " -> " + status);

            // Create JSON string for I2C transmission
            String dataToSend = "{\"device\":\"" + deviceType + "\",\"status\":\"" + status + "\"}";
            sendToArduino(dataToSend);
        }
    } else {
        Serial.println("‚ùå HTTP Request Failed");
    }

    http.end();
}

// ‚úÖ Send data to Arduino over I2C
void sendToArduino(String data) {
    Wire.beginTransmission(SLAVE_ADDR);
    Wire.write((const uint8_t*)data.c_str(), data.length());
    Wire.endTransmission();
}

// ‚úÖ Handle Bluetooth Input for WiFi/Server Config
void handleBluetoothInput(String input) {
    input.trim();
    bool shouldReconnect = false;

    if (input.startsWith("ssid:")) {
        ssid = input.substring(5);
        preferences.putString("ssid", ssid);
        SerialBT.println("SSID updated to: " + ssid);
        shouldReconnect = true;
    } else if (input.startsWith("pw:")) {
        pw = input.substring(3);
        preferences.putString("password", pw);
        SerialBT.println("Password updated.");
        shouldReconnect = true;
    } else if (input.startsWith("serverUrl:")) {
        serverUrl = input.substring(10);
        preferences.putString("serverUrl", serverUrl);
        SerialBT.println("Server URL updated.");
    } else {
        SerialBT.println("Invalid command. Use ssid:<value>, pw:<value>, or serverUrl:<value>");
    }

    if (shouldReconnect) {
        reconnectWiFi();
    }
}

// ‚úÖ Reconnect to WiFi
void reconnectWiFi() {
    SerialBT.println("Reconnecting to WiFi...");
    WiFi.disconnect();
    delay(1000);

    WiFi.begin(ssid.c_str(), pw.c_str());

    int retry = 0;
    while (WiFi.status() != WL_CONNECTED && retry < 20) {
        delay(1000);
        Serial.print(".");
        SerialBT.print(".");
        retry++;
    }

    if (WiFi.status() == WL_CONNECTED) {
        Serial.println("\nReconnected to WiFi.");
        Serial.print("New IP Address: ");
        Serial.println(WiFi.localIP());

        SerialBT.println("\nReconnected to WiFi.");
        SerialBT.print("New IP Address: ");
        SerialBT.println(WiFi.localIP());
    } else {
        Serial.println("\nFailed to reconnect to WiFi.");
        SerialBT.println("\nFailed to reconnect to WiFi.");
    }
}
